---
description: "[ULTRAHONK] Main development workflow for Solana Noir Verifier"
globs:
alwaysApply: true
---

# Solana UltraHonk Verifier Workflow

This rule applies to ALL interactions with this codebase.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    CIRCUIT DEPLOYMENT                        │
│                     (once per circuit)                       │
├─────────────────────────────────────────────────────────────┤
│  1. Create VK account                                        │
│  2. Upload VK (2 chunks for 1,760 bytes)                    │
│  → VK Account pubkey (save for proof verification)          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   PROOF VERIFICATION                         │
│                      (per proof)                             │
├─────────────────────────────────────────────────────────────┤
│  1. Create proof + state accounts (1 TX)                    │
│  2. Upload proof (19 chunks in parallel)                    │
│  3. Phase 1: Challenges (pass VK account)                   │
│  4. Phase 2: Sumcheck (3 TXs)                               │
│  5. Phase 3c+4: MSM + Pairing (pass VK account)             │
│  → Verification result                                       │
└─────────────────────────────────────────────────────────────┘
```

## 1. Proof Generation (Noir + bb)

```bash
cd test-circuits/<circuit_name>

# Compile + execute
nargo compile && nargo execute

# Generate ZK proof (ALWAYS use keccak + zk for Solana)
~/.bb/bb prove \
    -b ./target/<circuit>.json \
    -w ./target/<circuit>.gz \
    --oracle_hash keccak --zk \
    -o ./target/keccak

# Generate VK
~/.bb/bb write_vk \
    -b ./target/<circuit>.json \
    --oracle_hash keccak \
    -o ./target/keccak
```

Or use `./build_all.sh <circuit_name>` from `test-circuits/`.

## 2. Build & Deploy Verifier Program

```bash
# Build the verifier program (circuit-agnostic)
cd programs/ultrahonk-verifier
cargo build-sbf

# Start local validator
surfpool  # or: solana-test-validator

# Deploy
solana program deploy target/deploy/ultrahonk_verifier.so \
    --url http://127.0.0.1:8899 --use-rpc
# → Note the Program Id
```

## 3. Run End-to-End Test

```bash
cd /path/to/solana-noir-verifier

# Set environment variables
export PROGRAM_ID=<program_id_from_deploy>
export RPC_URL=http://127.0.0.1:8899
export CIRCUIT=simple_square  # optional, defaults to simple_square

# Run test
node scripts/solana/test_phased.mjs
```

Expected output:
- Circuit Deployment: ~0.8s (one-time)
- Proof Verification: ~6s (8 TXs, ~5.4M CUs)

## 4. Reference the Spec

Before modifying verification logic:
- **`tasks.md`** - Current status and implementation notes
- **`docs/knowledge.md`** - Implementation details and gotchas
- Generate Solidity verifier with `bb contract` for comparison

## 5. Documentation Updates

After completing work:
- Update `tasks.md` with status
- Update `docs/knowledge.md` with discoveries
- Update `README.md` if commands change

## 6. Debugging Tips

```bash
# Get bb's internal challenge values
bb verify -d -p ./proof -k ./vk --oracle_hash keccak --zk

# Generate Solidity verifier for reference
bb contract -k ./vk -o ./HonkVerifier.sol --oracle_hash keccak

# Check bb version
~/.bb/bb --version  # Should be 0.87.x
```

If challenges don't match:
1. Check transcript element order matches Solidity
2. Verify G1 points are in **limbed format** (128 bytes)
3. Check for missing libra commitments (ZK mode)

## 7. Cost Estimates (Mainnet)

| Component | Cost |
|-----------|------|
| Per proof verification | ~$1.10 (8 TXs, priority fees) |
| Circuit deployment | ~$0.003 (one-time) |
| Rent deposits (recoverable) | ~$33 per proof |
