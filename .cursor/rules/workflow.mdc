---
description: Main development workflow for Solana Noir Verifier
globs:
alwaysApply: true
---

# Solana Noir Verifier Workflow

This rule applies to ALL interactions with this codebase.

## 1. Reference the Spec First

Before implementing or modifying any verification logic, transcript handling, or cryptographic operations:

- **Consult `SPEC.md`** - High-level specification
- **Consult `tasks.md`** - Current status and implementation notes
- **Consult `docs/knowledge.md`** - Discovered implementation details
- For transcript matching: generate Solidity verifier with `bb contract` and compare

## 2. Proof Generation Workflow

When working with test circuits or generating new proofs:

```bash
cd test-circuits/<circuit_name>

# 1. Compile circuit
nargo compile

# 2. Generate witness
nargo execute

# 3. Generate ZK proof (ALWAYS use keccak + zk for Solana)
~/.bb/bb prove \
    -b ./target/<circuit>.json \
    -w ./target/<circuit>.gz \
    --oracle_hash keccak --zk \
    -o ./target/keccak

# 4. Generate VK
~/.bb/bb write_vk \
    -b ./target/<circuit>.json \
    --oracle_hash keccak \
    -o ./target/keccak

# 5. Verify externally (sanity check)
~/.bb/bb verify -p ./target/keccak/proof -k ./target/keccak/vk \
    --oracle_hash keccak --zk
```

Or use `./build_all.sh <circuit_name>` from `test-circuits/`.

## 3. Multi-Circuit Build & Test

The Solana program embeds a circuit-specific VK at compile time:

```bash
# Build for specific circuit
cd programs/ultrahonk-verifier
CIRCUIT=hash_batch cargo build-sbf

# Deploy to Surfpool
solana program deploy target/deploy/ultrahonk_verifier.so \
    --url http://127.0.0.1:8899 --use-rpc

# Test with matching circuit
cd ../..
CIRCUIT=hash_batch node scripts/solana/test_phased.mjs
```

Available circuits: `simple_square`, `iterated_square_*`, `fib_chain_100`, `hash_batch`, `merkle_membership`

## 4. Update Documentation After Sessions

After completing work or making significant discoveries:

- **Update `tasks.md`** with checked items, new tasks, and status
- **Update `docs/knowledge.md`** with implementation details and gotchas
- **Update `README.md`** if build/test commands or structure changes

## 5. Test Against Spec

When implementing features:

- Run `cargo test -p plonk-solana-core` (58 tests)
- Run `test_all_available_circuits` for comprehensive check
- For debugging, use `bb verify -d` to get internal challenge values
- Compare against generated Solidity verifier for challenge matching

## 6. Debugging Challenge Mismatches

If challenges don't match:

1. Generate Solidity verifier: `bb contract -k ./vk -o ./HonkVerifier.sol --oracle_hash keccak`
2. Add debug prints in Rust and compare hex values
3. Check transcript element order matches Solidity exactly
4. Verify G1 points are added in **limbed format** (128 bytes, not 64!)
5. Check for missing elements (e.g., libra commitments for ZK proofs)
